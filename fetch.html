<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Fetch demo</title>
    <link rel="stylesheet" type="text/css" href="css/reset.css">
    <!-- bootstrap -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">
    <script src="scripts/ajaxHandler.js"></script>
    <!--vue.js-->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.5.13/dist/vue.js"></script>
    <!--fetch polyfill-->
    <script src="lib/fetch.js"></script>
    <!-- besTemplate -->
    <script src="scripts/besTemplate.js"></script>
    <link rel="stylesheet" type="text/css" href="css/besTemplate.css">
    <!-- customer script style -->
    <style type="text/css">
    #app {
        padding: 10px;
    }

    .flex {
        align-items: flex-start;
        display: flex;
        margin-bottom: 10px;
    }

    .flex-col {
        margin-right: 20px;
        display: flex;
        justify-content: center;
        flex-direction: column;
    }

    .pool {
        width: 150px;
        text-align: center;
    }

    .box {
        width: 100%;
        box-sizing: border-box;
        border: 1px solid black;
    }
    </style>
</head>

<body>
    <div id="app">
        <h3>BesAjaxRequest</h3>
        <div class="flex" style="flex-wrap: wrap;">
            <div class="flex-col">
                <label>delay,primary 0</label>
                <ajax-btn class="btn btn-primary" text="send" :bes_ajax="delayRequest"></ajax-btn>
            </div>
            <div class="flex-col">
                <label>delay post,primary 0</label>
                <ajax-btn class="btn btn-primary" text="send" :bes_ajax="postRequest"></ajax-btn>
            </div>
            <div class="flex-col">
                <label>instant,primary 1</label>
                <ajax-btn class="btn btn-primary" text="send" :bes_ajax="instantRequest"></ajax-btn>
            </div>
            <div class="flex-col">
                <label>instant2,primary 5</label>
                <ajax-btn class="btn btn-primary" text="send" :bes_ajax="instantRequest2"></ajax-btn>
            </div>
            <div class="flex-col">
                <label>send 10 badRequest</label>
                <button class="btn btn-primary" onclick="sendBadRequest()">send</button>
            </div>
        </div>
        <div class="flex">
            <div class="contain-box flex-col pool">
                <h4>pool size</h4>
                <input type="text" v-model="controll.poolSize">
            </div>
            <div class="contain-box flex-col pool">
                <h4>exePool</h4>
                <div class="box" style="background-color: lime;" v-for="t in exePool">{{t.options.name}}</div>
            </div>
            <div class="contain-box flex-col pool">
                <h4>waitingPool</h4>
                <div class="box" style="background-color: lightblue;" v-for="t in waitingPool">{{t.options.name}}</div>
            </div>
            <div class="contain-box flex-col">
                <h4>results ( 30 lines ):</h4>
                <div v-for="r in results">{{r}}</div>
            </div>
        </div>
    </div>
    <script type="text/javascript">
    const besAjax = BesAjaxRequest()
    besAjax.log = true;
    besAjax.resolveFirst = false;
    besAjax.poolSize = 5;
    const defaultRequest = besAjax.createRequest({
        host: 'http://127.0.0.1:3000'
    }, {
        responseType: 'text',
        primary: 5,
        timeout: 4000,
    })

    const badRequest = defaultRequest.extend({
        path: 'api/fatal'
    }, {
        retry: 5,
        sleep: 500
    })
    const delayRequest = defaultRequest.extend({
        path: 'api/delay'
    }, {
        name: 'delayRequest',
        primary: 0
    })
    const instantRequest = defaultRequest.extend({
        path: 'api'
    }, {
        name: 'instantRequest',
        primary: 1,
        responseType: 'json'
    })

    const app = new Vue({
        el: '#app',
        data: {
            results: [],
            exePool: [],
            waitingPool: [],
            controll : besAjax,
            delayRequest: delayRequest,
            postRequest: delayRequest.extend({
                method: 'post',
                body: JSON.stringify({ "name": "postRequest" }),
                headers: { 'Content-Type': 'application/json' }
            }, {
                name: 'postRequest',
                primary: 0
            }),
            instantRequest: instantRequest,
            instantRequest2: instantRequest.extend({}, { name: 'instantRequest2', primary: 5, responseType: 'text' })
        }
    })
    besAjax.successHandler = function(res, name) {
        app.results.unshift(`[${name} done]: response: ${res}`)
        if (app.results.length > 30)
            app.results.pop()
    }
    besAjax.errorHandler = function(e, name) {
        app.results.unshift(`[${name} fail]: error: ${e}`)
        if (app.results.length > 30)
            app.results.pop()
    }
    besAjax.taskPool.on('pool', function() {
        app.exePool = besAjax.taskPool.exePool;
        app.waitingPool = besAjax.taskPool.waitingPool
    })

    function sendBadRequest() {
        for (let i = 0; i < 15; i++) {
            badRequest.extend({ query: `index=${i}` }, { name: `badRequest${i}` }).send()
                .then(function(res) {})
                .catch(function(e) {})
        }
    }
    sendBadRequest();
    for(let i=0;i<5;i++){
        delayRequest.extend({query:'i='+i},{primary:4,name:'delayRequest5'}).send()
    }
    setTimeout(function(){
        for(let i=0;i<5;i++){
            delayRequest.extend({path:'api/delay2',query:'i='+i},{primary:0,name:'delayRequest0'}).send()
        }
    },100)
    
    </script>
</body>

</html>